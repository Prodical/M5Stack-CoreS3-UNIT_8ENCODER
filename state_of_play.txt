M5Stack CoreS3 UNIT_8ENCODER BLE MIDI Controller
State of Play - 2025-12-04 19:46 UTC

=== COMPLETED FEATURES ===

1. BLE MIDI Integration (2025-12-02 20:50 UTC)
   - Added BLEMIDI_Transport library with ESP32 native BLE stack
   - Device advertises as "CoreS3 8Enc MIDI"
   - Callbacks for connection/disconnection tracking
   - MIDI.read() in main loop maintains BLE stack

2. Switch-Based Mode Control (2025-12-02 21:20 UTC)
   - Switch ON: Encoders 5-7 control musical parameters
     * Encoder 5: Octave selection (-1 to 9)
     * Encoder 6: Root note selection (12 chromatic notes)
     * Encoder 7: Scale selection (9 scales)
     * Encoders 0-4: Reserved for future use
   - Switch OFF: Encoders 0-6 send MIDI notes on button press/release
     * Each encoder mapped to corresponding scale note
     * Per-encoder velocity controlled by rotation
     * Encoder 7: Reserved for future use

3. Scale-Based MIDI Note Mapping (2025-12-02 21:22 UTC)
   - Encoders 0-6 buttons trigger scale note NoteOn/NoteOff messages
   - MIDI note = scale_note + ((octave + 1) * 12)
   - Formula corrects for MIDI standard (C4 = note 60)
   - C Major default: encoder 0=C, 1=D, 2=E, 3=F, 4=G, 5=A, 6=B

4. Per-Encoder Velocity Control (2025-12-03 17:47 UTC)
   - Switch OFF: Encoder rotation controls velocity (0-127)
   - 60 clicks per full turn (30 detents × 2 clicks/detent)
   - Encoders initialize to 60 (velocity 127) via sensor.setEncoderValue()
   - ACW turn decreases velocity from 127 to 0
   - CW turn has no effect when already at max (clamped at 127)
   - Values clamped 0-127

5. Velocity Visualization (2025-12-02 22:45 UTC)
   - Mid-grey bars display velocity for each scale note
   - Bar dimensions: base 85, max height 35
   - Black keys offset 10px upward (matching key layout)
   - Bar color changes with button state:
     * Mid-grey: idle/default
     * Orange: short press
     * Green: hold/active
   - Height mapped 0-127 velocity to 0-35px

6. Button State Management (2025-12-02 22:12 UTC)
   - Short press: NoteOn on press, NoteOff on release
   - Hold (1s): NoteOn on activation, NoteOff on deactivation by second press
   - LED feedback: orange (short press), green (active/hold)

7. Encoder 7 Parameter Mode System (2025-12-04 19:46 UTC)
   - Four modes: DEFAULT, SCALE, ROOT, OCTAVE
   - Mode cycling via short button press (<500ms)
   - Visual feedback:
     * Encoder 7 circle: mid grey (idle), white (short press)
     * MODE_SCALE: scale name flashes at 5Hz (white/mid-grey)
     * MODE_ROOT: root note flashes at 5Hz (white/mid-grey)
     * MODE_OCTAVE: octave numbers flash at 5Hz (white/green/mid-grey)
   - MODE_DEFAULT: encoder rotation visible but no parameter changes
   - Encoder rotation always updates GUI display
   - Works regardless of switch state (consolidated control)

8. Info Sprite Layout Redesign (2025-12-04 19:46 UTC)
   - Root note: top-left corner (3, 3)
   - Scale name: offset right (30, 8)
   - Interval formula: below root (3, 33)
   - Rounded rectangle outline (176px × 52px) around all labels
   - Info sprite height: 52px (increased from 50px)
   - Keys sprite position: Y=52 (moved down to prevent cutoff)

=== PENDING FEATURES ===

- Encoder 0-4 functionality in Switch ON mode: TBD

=== TECHNICAL NOTES ===

- BLE MIDI library conflict resolved by removing ArduinoBLE
- ESP32 native BLE library handles BLEMIDI_Transport
- Velocity bar base Y calculated within keys sprite coordinates (320x150)
- MIDI channel: 1 (hardcoded)
- MIDI velocity scaled per-encoder from rotation

=== BUILD STATUS ===

- Compiling successfully
- All features tested and working
- Ready for feature integration

=== DEVELOPMENT ROADMAP ===

Immediate/High Priority:
1. Encoder 0-4 functionality in Switch ON mode
   - Currently reserved for future use
   - Could control CC values, reverb/effects, volume, etc.
   - Would expand musical expressiveness beyond scale notes

2. Encoder 7 in Switch OFF mode
   - Currently reserved
   - Could control MIDI channel selection
   - Or octave transpose (shift all notes up/down)
   - Or CC modulation depth

3. Scale note preview/indication on display
   - Visual highlight which scale notes are currently playable
   - Show octave being played
   - Display active encoder for MIDI feedback

Medium Priority:
4. MIDI CC output - Separate from note messages
   - Use rotation data to send CC messages
   - Could be tied to encoders 0-4 in Switch ON mode
   - Useful for DAW parameter control

5. Chord/arpeggiator mode
   - Multiple encoder buttons held simultaneously = chord
   - Or encoder rotation triggers arpeggio patterns

6. Persistence - Save settings to NVS
   - Remember last scale/octave/root on power cycle
   - Store user presets

Polish/Quality:
7. Display improvements
   - Show current MIDI note number when button pressed
   - Display velocity value numerically
   - Real-time BLE connection indicator

8. Performance optimization
   - Profile memory usage (spare RAM available)
   - Reduce I2C communication overhead if needed
